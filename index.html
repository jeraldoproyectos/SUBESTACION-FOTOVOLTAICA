<!DOCTYPE html>
<html lang="es">
<head>
    <title>GESTIÓN TÉCNICA - SUBESTACIÓN</title>
    <meta charset="utf-8" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        :root { 
            --navy-dark: #0f172a; --navy-light: #1e293b; --accent-blue: #3b82f6; 
            --utm-green: #22c55e; --project-gold: #f59e0b; --text-main: #f8fafc;
        }

        body { margin: 0; padding: 0; background: var(--navy-dark); font-family: 'Inter', sans-serif; display: flex; height: 100vh; overflow: hidden; }

        /* SIDEBAR */
        #sidebar { width: 320px; background: #ffffff; border-right: 1px solid #e2e8f0; display: flex; flex-direction: column; z-index: 2500; }
        .sidebar-header { padding: 20px; background: var(--navy-dark); color: white; border-bottom: 4px solid var(--accent-blue); }
        .sidebar-scroll { flex-grow: 1; overflow-y: auto; padding: 15px; background: #f8fafc; color: #334155; }
        .section-title { font-weight: 800; font-size: 10px; color: #94a3b8; text-transform: uppercase; margin: 20px 0 10px; letter-spacing: 1.5px; border-bottom: 1px solid #e2e8f0; }

        /* CARDS */
        .feature-card { background: white; border: 1px solid #e2e8f0; border-radius: 6px; margin-bottom: 8px; border-left: 4px solid #cbd5e1; padding: 10px; font-size: 12px; font-weight: 600; }

        /* MAPA */
        #map-container { flex-grow: 1; position: relative; }
        #map { width: 100%; height: 100%; background: #020617; }
        
        /* UI INFERIOR */
        .ui-bottom { position: absolute; bottom: 30px; left: 50%; transform: translateX(-50%); width: 620px; z-index: 2000; display: flex; flex-direction: column; align-items: center; gap: 12px; }
        .utm-box { background: var(--navy-dark); color: var(--utm-green); padding: 6px 14px; border-radius: 20px; font-family: monospace; font-size: 11px; border: 1px solid var(--navy-light); box-shadow: 0 10px 15px rgba(0,0,0,0.5); }
        
        .controls-wrapper { 
            background: rgba(15, 23, 42, 0.95); padding: 15px 25px; border-radius: 50px; width: 100%; 
            border: 1px solid rgba(255,255,255,0.1); display: flex; align-items: center; gap: 20px;
            backdrop-filter: blur(10px); box-shadow: 0 20px 25px rgba(0,0,0,0.5);
        }

        .slider-section { flex-grow: 1; display: flex; flex-direction: column; }
        .current-date-label { color: white; font-size: 10px; font-weight: 700; text-transform: uppercase; margin-bottom: 4px; letter-spacing: 1px; }
        input[type=range] { width: 100%; accent-color: var(--accent-blue); cursor: pointer; }

        /* BOTÓN PROYECTO */
        .project-toggle { border-left: 1px solid rgba(255,255,255,0.2); padding-left: 20px; }
        .btn-project { 
            background: none; border: 2px solid var(--project-gold); color: var(--project-gold);
            padding: 10px 20px; border-radius: 25px; font-weight: 800; font-size: 11px; 
            cursor: pointer; transition: 0.3s; text-transform: uppercase; letter-spacing: 1px;
        }
        .btn-project.active { background: var(--project-gold); color: var(--navy-dark); box-shadow: 0 0 15px rgba(245, 158, 11, 0.4); }

        /* TOOLBAR */
        #toolbar { position: absolute; right: 20px; top: 50%; transform: translateY(-50%); z-index: 2000; display: flex; flex-direction: column; gap: 12px; }
        .tool-btn { width: 48px; height: 48px; background: white; border-radius: 12px; border: none; cursor: pointer; display: flex; align-items: center; justify-content: center; box-shadow: 0 4px 12px rgba(0,0,0,0.2); transition: 0.2s; }
        .tool-btn svg { width: 22px; height: 22px; stroke: #475569; fill: none; stroke-width: 2.5; }
        .tool-btn.active { background: var(--accent-blue); }
        .tool-btn.active svg { stroke: white; }
    </style>
</head>
<body>

<div id="sidebar">
    <div class="sidebar-header"><h3>CONTROL DE OBRA</h3></div>
    <div class="sidebar-scroll">
        <div class="section-title">Líneas</div><div id="list-line"></div>
        <div class="section-title">Áreas</div><div id="list-area"></div>
        <div class="section-title">Puntos</div><div id="list-point"></div>
    </div>
</div>

<div id="map-container">
    <div id="map"></div>
    
    <div id="toolbar">
        <button class="tool-btn" id="btn-line"><svg viewBox="0 0 24 24"><path d="M5 19L19 5"/></svg></button>
        <button class="tool-btn" id="btn-area"><svg viewBox="0 0 24 24"><path d="M4 4h10l6 6-6 6H4z"/></svg></button>
        <button class="tool-btn" id="btn-point"><svg viewBox="0 0 24 24"><circle cx="12" cy="10" r="3"/><path d="M12 21s-9-9-9-13a9 9 0 0118 0c0 4-9 13-9 13z"/></svg></button>
    </div>

    <div class="ui-bottom">
        <div class="utm-box" id="utm-coord">E: --- | N: ---</div>
        <div class="controls-wrapper">
            <div class="slider-section">
                <div id="fecha-label" class="current-date-label">HISTORIAL DE VUELOS</div>
                <input type="range" id="smooth-slider" min="0" value="0" step="1">
            </div>
            <div class="project-toggle">
                <button class="btn-project" id="toggle-proyecto">Fundaciones</button>
            </div>
        </div>
    </div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/proj4js/2.9.0/proj4.js"></script>

<script>
    // 1. CONFIGURACIÓN UTM (Zona 19 Sur)
    var utm19S = "+proj=utm +zone=19 +south +datum=WGS84 +units=m +no_defs";
    var wgs84 = "+proj=longlat +datum=WGS84 +no_defs";
    const toUTM = (ll) => {
        const p = proj4(wgs84, utm19S, [ll.lng, ll.lat]);
        return { x: p[0], y: p[1] };
    };

    var map = L.map('map', { zoomControl: false, minZoom: 17, maxZoom: 23 }).setView([-20.351387, -69.721985], 19);
    
    // Google Satellite como base mínima
    L.tileLayer('https://mt1.google.com/vt/lyrs=s&x={x}&y={y}&z={z}', { maxZoom: 23, opacity: 0.3 }).addTo(map);

    // 2. ORTOFOTO PROYECTO (Carpeta "fundaciones")
    // Se carga como TileLayer para máxima resolución y fluidez
    var capaFundaciones = L.tileLayer('fundaciones/Z{z}/{y}/{x}.png', {
        maxZoom: 23,
        zIndex: 1000, // Siempre por encima de las fotos del historial
        opacity: 0.9
    });

    var btnFund = document.getElementById('toggle-proyecto');
    btnFund.onclick = function() {
        if (map.hasLayer(capaFundaciones)) {
            map.removeLayer(capaFundaciones);
            this.classList.remove('active');
        } else {
            capaFundaciones.addTo(map);
            this.classList.add('active');
        }
    };

    // 3. SLIDER CRONOLÓGICO (5 ORTOFOTOS DE PROGRESO)
    var fechas = ["03/12/2025", "09/01/2026", "21/01/2026", "23/01/2026", "28/01/2026"];
    var capasAvance = fechas.map((f, i) => {
        return L.tileLayer(f.replace(/\//g, '') + '/Z{z}/{y}/{x}.png', { 
            maxZoom: 23, 
            opacity: (i === 0 ? 1 : 0) 
        }).addTo(map);
    });

    var slider = document.getElementById('smooth-slider');
    slider.max = (capasAvance.length - 1) * 100;

    slider.oninput = function() {
        var val = parseFloat(this.value);
        var idx = Math.floor(val / 100);
        var sub = (val % 100) / 100;
        if (idx >= capasAvance.length - 1) { idx = capasAvance.length - 2; sub = 1; }
        
        capasAvance.forEach((c, i) => {
            let op = (i === idx) ? 1 - sub : (i === idx + 1 ? sub : 0);
            c.setOpacity(op);
        });
        document.getElementById('fecha-label').innerText = "Vuelo: " + ((sub > 0.5) ? fechas[idx + 1] : fechas[idx]);
    };

    // 4. COORDINADAS UTM AL MOVER EL MOUSE
    map.on('mousemove', (e) => {
        const u = toUTM(e.latlng);
        document.getElementById('utm-coord').innerText = `E: ${u.x.toLocaleString('en-US', {minimumFractionDigits:2})} | N: ${u.y.toLocaleString('en-US', {minimumFractionDigits:2})}`;
    });

    // 5. HERRAMIENTAS DE DIBUJO BÁSICAS
    let currentMode = null, drawingPoints = [], tempLayer = null;
    let counters = { line: 0, area: 0, point: 0 };

    function setMode(mode) {
        currentMode = mode; drawingPoints = [];
        if(tempLayer) map.removeLayer(tempLayer);
        document.querySelectorAll('.tool-btn').forEach(b => b.classList.remove('active'));
        if(mode) document.getElementById(`btn-${mode}`).classList.add('active');
    }

    document.getElementById('btn-line').onclick = () => setMode('line');
    document.getElementById('btn-area').onclick = () => setMode('area');
    document.getElementById('btn-point').onclick = () => setMode('point');

    map.on('click', (e) => {
        if (!currentMode) return;
        if (currentMode === 'point') { 
            L.circleMarker(e.latlng, { radius: 6, color: 'red', fillColor: 'white', fillOpacity: 1 }).addTo(map);
            addCard('point'); setMode(null); 
        } else if (currentMode === 'line') {
            drawingPoints.push(e.latlng);
            if (drawingPoints.length === 2) { 
                L.polyline(drawingPoints, {color:'red', weight:3}).addTo(map);
                addCard('line'); setMode(null); 
            }
        } else if (currentMode === 'area') {
            drawingPoints.push(e.latlng);
            if (tempLayer) map.removeLayer(tempLayer);
            tempLayer = L.polyline(drawingPoints, {color:'red', weight: 2}).addTo(map);
            if (drawingPoints.length >= 3 && map.distance(e.latlng, drawingPoints[0]) < 15) {
                L.polygon(drawingPoints, {color:'red', weight:2, fillOpacity:0.3}).addTo(map);
                addCard('area'); setMode(null);
            }
        }
    });

    function addCard(type) {
        counters[type]++;
        const card = document.createElement('div');
        card.className = 'feature-card';
        card.innerText = `${type==='line'?'LÍNEA':type==='area'?'ÁREA':'PTO'} ${counters[type]}`;
        document.getElementById(`list-${type}`).appendChild(card);
    }
</script>
</body>
</html>
