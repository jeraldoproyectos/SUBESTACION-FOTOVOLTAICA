<!DOCTYPE html>
<html>
<head>
    <title>SUBESTACION FOTOVOLTAICA</title>
    <meta charset="utf-8" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        body { margin: 0; padding: 0; background: #1a1a1a; font-family: 'Segoe UI', sans-serif; overflow: hidden; }
        #map { height: 100vh; width: 100%; cursor: crosshair; }
        
        .brand-logo {
            position: absolute; bottom: 20px; left: 20px; z-index: 2500;
            width: 150px; filter: drop-shadow(0 2px 5px rgba(0,0,0,0.7));
            pointer-events: none;
        }

        /* nuevo logo en la esquina superior derecha */
        .corner-logo {
            position: absolute;
            top: 15px;
            right: 15px;
            z-index: 2500;
            width: 80px; /* ajusta tamaño */
            pointer-events: none;
        }

        /* panel vertical de herramientas debajo del logo */
        .tool-panel {
            position: absolute;
            top: 105px;      /* debajo del logo; ajusta si hace falta */
            right: 20px;
            z-index: 2500;
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        .tool-btn {
            background: #ffffff;
            border-radius: 18px;
            border: 1px solid #c0cfd9;
            padding: 6px 14px;
            font-size: 13px;
            cursor: pointer;
            color: #333;
            box-shadow: 0 1px 2px rgba(0,0,0,0.25);
        }

        .tool-btn.active {
            background: #e6f0ff;
            border-color: #2b73ff;
            color: #2b73ff;
        }

        .ui-container {
            position: absolute; bottom: 25px; left: 50%; transform: translateX(-50%);
            width: 25%; min-width: 220px; z-index: 2000;
            display: flex; flex-direction: column; align-items: center; gap: 8px;
        }

        .utm-box {
            background: rgba(0,0,0,0.9); color: #00ff00; padding: 5px 12px;
            border-radius: 4px; border: 1px solid #444; font-family: monospace;
            font-size: 11px; font-weight: bold;
        }

        .slider-wrapper {
            background: rgba(0,0,0,0.9); padding: 9px 11px; border-radius: 6px;
            width: 100%; border: 1px solid #333; text-align: center;
        }

        .current-date-label { 
            display: inline-block; color: #00ff00; font-size: 11px; font-weight: bold;
            border: 1px solid #00ff00; padding: 1.5px 6px; border-radius: 3px;
            margin-bottom: 6px; background: rgba(0, 255, 0, 0.05);
        }

        .date-active { background: #00ff00 !important; color: #000 !important; }
        input[type=range] { width: 100%; cursor: pointer; accent-color: #00ff00; height: 3px; }
    </style>
</head>
<body>

<!-- Cuando tengas el logo final, reemplaza "logo.jpg" por la ruta correcta -->
<img src="logo.jpg" class="brand-logo" alt="Logo SUBESTACION FOTOVOLTAICA">

<!-- nuevo logo en la esquina superior derecha -->
<img src="pngegg.png" class="corner-logo" alt="Logo esquina">

<!-- panel de herramientas debajo del logo -->
<div class="tool-panel">
    <button id="btn-area" class="tool-btn active">Área</button>
    <button id="btn-dist" class="tool-btn">Distancia</button>
    <button id="btn-point" class="tool-btn">Punto</button>
</div>

<div id="map"></div>

<div class="ui-container">
    <div class="utm-box" id="utm-coord">E: --- | N: ---</div>
    <div class="slider-wrapper">
        <div id="fecha-label" class="current-date-label">CARGANDO...</div>
        <input type="range" id="smooth-slider" min="0" value="0" step="1">        
    </div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/proj4js/2.9.0/proj4.js"></script>

<script>
    // Proyecciones UTM 19S y WGS84
    var utm19S = "+proj=utm +zone=19 +south +datum=WGS84 +units=m +no_defs";
    var wgs84 = "+proj=longlat +datum=WGS84 +no_defs";

    // Mapa base
    var map = L.map('map', { zoomControl: false, minZoom: 18, maxZoom: 23 })
              .setView([-20.351387, -69.721985], 19);

    // Ortofoto base de Google
    L.tileLayer('https://mt1.google.com/vt/lyrs=s&x={x}&y={y}&z={z}', {
        maxZoom: 23
    }).addTo(map);

    // Pane para el plano (fundaciones)
    map.createPane('planoPane');
    map.getPane('planoPane').style.zIndex = 1000;
    map.getPane('planoPane').style.pointerEvents = 'none';

    // Coordenadas de la imagen de fundaciones
    var imageBounds = [
        [-20.3519680745, -69.7226506296], // Sur-Oeste
        [-20.3506811321, -69.7212255524]  // Norte-Este
    ];

    // Plano de fundaciones
    L.imageOverlay('fundaciones.png', imageBounds, {
        pane: 'planoPane',
        opacity: 0.9,
        interactive: false
    }).addTo(map);

    // Coordenadas UTM bajo el mouse
    map.on('mousemove', function(e) {
        var p = proj4(wgs84, utm19S, [e.latlng.lng, e.latlng.lat]);
        document.getElementById('utm-coord').innerHTML =
            'E: ' + p[0].toFixed(2) + ' | N: ' + p[1].toFixed(2);
    });

    // Fechas de tus ortofotos
    var fechas = ["03/12/2025", "09/01/2026", "21/01/2026", "23/01/2026", "28/01/2026"];

    // Capas raster tipo XYZ
    var capas = [
        L.tileLayer('03122025/Z{z}/{y}/{x}.png', { maxZoom: 23, opacity: 1 }).addTo(map),
        L.tileLayer('09012026/Z{z}/{y}/{x}.png', { maxZoom: 23, opacity: 0 }).addTo(map),
        L.tileLayer('21012026/Z{z}/{y}/{x}.png', { maxZoom: 23, opacity: 0 }).addTo(map),
        L.tileLayer('23012026/Z{z}/{y}/{x}.png', { maxZoom: 23, opacity: 0 }).addTo(map),
        L.tileLayer('28012026/Z{z}/{y}/{x}.png', { maxZoom: 23, opacity: 0 }).addTo(map)
    ];

    // Slider para transición suave entre fechas
    var slider = document.getElementById('smooth-slider');
    var label = document.getElementById('fecha-label');
    slider.max = (capas.length - 1) * 100;

    function updateView() {
        var val = parseFloat(slider.value);
        var snappingPoint = Math.round(val / 100) * 100;
        if (Math.abs(val - snappingPoint) < 12) { val = snappingPoint; }

        var index = Math.floor(val / 100);
        var subVal = (val % 100) / 100;
        if (index >= capas.length - 1) { index = capas.length - 2; subVal = 1; }
        
        capas.forEach(function(c, i) {
            if (i === index) c.setOpacity(1 - subVal);
            else if (i === index + 1) c.setOpacity(subVal);
            else c.setOpacity(0);
        });
        
        var fechaActual = (subVal > 0.5) ? fechas[index + 1] : fechas[index];
        label.innerText = fechaActual;

        if (subVal === 0 || subVal === 1) label.classList.add('date-active');
        else label.classList.remove('date-active');
    }

    slider.addEventListener('input', updateView);
    slider.addEventListener('change', function() {
        this.value = Math.round(this.value / 100) * 100;
        updateView();
    });

    updateView();

// ---------------- Herramientas Área / Distancia / Punto ----------------
var currentTool = null;

function clearDrawingMode() {
    map.pm.disableDraw('Polygon');
    map.pm.disableDraw('Line');
    map.pm.disableDraw('Marker');
}

function setTool(tool) {
    currentTool = tool;

    // estado visual de botones
    document.querySelectorAll('.tool-btn').forEach(function(btn) {
        btn.classList.remove('active');
    });

    clearDrawingMode();

    if (tool === 'area') {
        document.getElementById('btn-area').classList.add('active');
        map.pm.enableDraw('Polygon', {
            snappable: true,
            allowSelfIntersection: false,
            tooltips: true,
            measurement: {
                measurement: true,
                displayFormat: 'metric'
            }
        });
    } else if (tool === 'dist') {
        document.getElementById('btn-dist').classList.add('active');
        map.pm.enableDraw('Line', {
            snappable: true,
            tooltips: true,
            measurement: {
                measurement: true,
                displayFormat: 'metric'
            }
        });
    } else if (tool === 'point') {
        document.getElementById('btn-point').classList.add('active');
        map.pm.enableDraw('Marker', {
            tooltips: true,
            measurement: {
                measurement: true,
                coordinates: true
            }
        });
    }
}

document.getElementById('btn-area').onclick  = function() { setTool('area'); };
document.getElementById('btn-dist').onclick  = function() { setTool('dist'); };
document.getElementById('btn-point').onclick = function() { setTool('point'); };

// Popup con m², distancia o coordenadas al finalizar
map.on('pm:create', function(e) {
    var layer = e.layer;
    var meas = L.PM.Utils.getMeasurements(layer, map, 'metric'); // área, longitud, coords [web:13]

    var content = '';

    if (layer instanceof L.Polygon && meas.area) {
        content = 'Área: ' + meas.area.toFixed(2) + ' m²';
    } else if (layer instanceof L.Polyline && meas.length) {
        content = 'Distancia: ' + meas.length.toFixed(2) + ' m';
    } else if (layer instanceof L.Marker && meas.coordinates) {
        content =
            'Lat: ' + meas.coordinates.lat.toFixed(6) +
            '<br>Lng: ' + meas.coordinates.lng.toFixed(6);
    }

    if (content) {
        layer.bindPopup(content).openPopup();
    }
});
</script>
</body>
</html>
