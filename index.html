<!DOCTYPE html>
<html lang="es">
<head>
    <title>GESTIÓN SUBESTACIÓN - CONTROL DE AVANCE</title>
    <meta charset="utf-8" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        :root { --primary-blue: #1976d2; --bg-dark: #1a1a1a; --utm-green: #00ff00; }
        body { margin: 0; padding: 0; background: var(--bg-dark); font-family: 'Segoe UI', sans-serif; display: flex; height: 100vh; overflow: hidden; color: white; }

        /* SIDEBAR */
        #sidebar { width: 340px; background: #f4f6f8; border-right: 1px solid #ddd; display: flex; flex-direction: column; z-index: 2500; color: #333; }
        .sidebar-header { padding: 15px; background: white; border-bottom: 1px solid #ddd; text-align: center; }
        .sidebar-scroll { flex-grow: 1; overflow-y: auto; padding: 15px; }
        .section-title { font-weight: bold; font-size: 11px; color: #888; text-transform: uppercase; margin: 15px 0 8px; letter-spacing: 1px; }

        /* MEDICIONES CARDS */
        .feature-card { background: white; border: 1px solid #e0e0e0; border-radius: 8px; margin-bottom: 8px; cursor: pointer; overflow: hidden; }
        .feature-card.selected { border-left: 6px solid var(--primary-blue); border-color: var(--primary-blue); box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
        .card-header { padding: 10px; display: flex; justify-content: space-between; align-items: center; }
        .card-title { font-weight: bold; font-size: 12px; color: #444; }
        .card-content { display: none; padding: 10px; border-top: 1px solid #eee; background: #fafafa; }
        .selected .card-content { display: block; }
        .utm-row { font-family: monospace; font-size: 10px; display: flex; justify-content: space-between; padding: 4px 0; border-bottom: 1px solid #eee; }
        .btn-del-main { background: none; color: #d32f2f; border: none; font-size: 10px; cursor: pointer; font-weight: bold; }

        /* UI MAPA */
        #map-container { flex-grow: 1; position: relative; }
        #map { width: 100%; height: 100%; background: #111; cursor: crosshair; }
        
        .ui-bottom { position: absolute; bottom: 25px; left: 50%; transform: translateX(-50%); width: 450px; z-index: 2000; display: flex; flex-direction: column; align-items: center; gap: 8px; }
        .utm-box { background: rgba(0,0,0,0.9); color: var(--utm-green); padding: 5px 12px; border-radius: 4px; font-family: monospace; font-size: 11px; border: 1px solid #444; }
        
        .comparator-wrapper { 
            background: rgba(0,0,0,0.95); padding: 12px; border-radius: 12px; width: 100%; 
            border: 1px solid #444; display: flex; justify-content: space-between; align-items: center; gap: 10px;
        }
        .selector-group { display: flex; flex-direction: column; flex: 1; }
        .selector-group label { font-size: 9px; color: #aaa; text-transform: uppercase; margin-bottom: 3px; font-weight: bold; }
        select { background: #222; color: white; border: 1px solid #444; padding: 5px; border-radius: 4px; font-size: 11px; cursor: pointer; }

        /* TOOLBAR */
        #toolbar { position: absolute; right: 15px; top: 50%; transform: translateY(-50%); z-index: 2000; display: flex; flex-direction: column; gap: 10px; }
        .tool-btn { width: 44px; height: 44px; background: white; border-radius: 10px; border: 1px solid #ccc; cursor: pointer; display: flex; align-items: center; justify-content: center; box-shadow: 0 2px 6px rgba(0,0,0,0.2); }
        .tool-btn.active { background: var(--primary-blue); border-color: white; }
        .tool-btn svg { width: 22px; height: 22px; stroke: #333; fill: none; stroke-width: 2; }
        .tool-btn.active svg { stroke: white; }
        #btn-project.active { background: #ff9800; border-color: white; }
        #btn-project.active svg { stroke: white; }

        .leaflet-sbs-divider { width: 4px; background-color: var(--utm-green); box-shadow: 0 0 10px rgba(0,255,0,0.5); }
        .point-name-label { font-weight: bold; color: #00ffff; font-size: 10px; text-shadow: 1px 1px 2px #000; white-space: nowrap; pointer-events: none; }
    </style>
</head>
<body>

<div id="sidebar">
    <div class="sidebar-header"><h3>GESTIÓN DE SUBESTACIÓN</h3></div>
    <div class="sidebar-scroll">
        <div class="section-title">Líneas</div><div id="list-line"></div>
        <div class="section-title">Áreas</div><div id="list-area"></div>
        <div class="section-title">Puntos</div><div id="list-point"></div>
    </div>
</div>

<div id="map-container">
    <div id="map"></div>
    
    <div class="ui-bottom">
        <div class="utm-box" id="utm-coord">E: --- | N: ---</div>
        <div class="comparator-wrapper">
            <div class="selector-group">
                <label>Lado Izquierdo</label>
                <select id="select-left"></select>
            </div>
            <div style="color: var(--utm-green); font-weight: bold;">VS</div>
            <div class="selector-group">
                <label>Lado Derecho</label>
                <select id="select-right"></select>
            </div>
        </div>
    </div>

    <div id="toolbar">
        <button class="tool-btn active" id="btn-project" title="Plano Fundaciones">
            <svg viewBox="0 0 24 24"><path d="M12 2L2 7l10 5 10-5-10-5zM2 17l10 5 10-5M2 12l10 5 10-5"/></svg>
        </button>
        <div style="height: 1px; background: #ddd; margin: 4px 0;"></div>
        <button class="tool-btn" id="btn-line" title="Línea"><svg viewBox="0 0 24 24"><path d="M5 19L19 5"/></svg></button>
        <button class="tool-btn" id="btn-area" title="Área"><svg viewBox="0 0 24 24"><path d="M4 4h10l6 6-6 6H4z"/></svg></button>
        <button class="tool-btn" id="btn-point" title="Punto"><svg viewBox="0 0 24 24"><circle cx="12" cy="10" r="3"/><path d="M12 21s-9-9-9-13a9 9 0 0118 0c0 4-9 13-9 13z"/></svg></button>
    </div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/proj4js/2.9.0/proj4.js"></script>
<script src="https://cdn.jsdelivr.net/gh/digidem/leaflet-side-by-side@gh-pages/leaflet-side-by-side.min.js"></script>

<script>
    // 1. CONFIGURACIÓN UTM Y MAPA
    var utm19S = "+proj=utm +zone=19 +south +datum=WGS84 +units=m +no_defs";
    var wgs84 = "+proj=longlat +datum=WGS84 +no_defs";
    const toUTM = (ll) => {
        const p = proj4(wgs84, utm19S, [ll.lng, ll.lat]);
        return { x: p[0], y: p[1] };
    };

    var map = L.map('map', { zoomControl: false, minZoom: 17, maxZoom: 23 }).setView([-20.351387, -69.721985], 19);
    L.tileLayer('https://mt1.google.com/vt/lyrs=s&x={x}&y={y}&z={z}', { maxZoom: 23 }).addTo(map);

    // 2. CAPA PROYECTO (FUNDACIONES) CON COORDENADAS AJUSTADAS (+26cm N, +7cm E)
    map.createPane('planoPane');
    map.getPane('planoPane').style.zIndex = 600;
    
    var imageBounds = [
        [-20.3516049645341, -69.7225702970685], 
        [-20.3507350930697, -69.7212299365804]
    ];
    var planoProyecto = L.imageOverlay('fundaciones.png', imageBounds, { pane: 'planoPane', opacity: 0.85 }).addTo(map);

    document.getElementById('btn-project').onclick = function() {
        this.classList.toggle('active');
        if (map.hasLayer(planoProyecto)) map.removeLayer(planoProyecto);
        else planoProyecto.addTo(map);
    };

    // 3. COMPARADOR SIDE-BY-SIDE (7 FECHAS)
    var fechas = ["03/12/2025", "09/01/2026", "21/01/2026", "23/01/2026", "28/01/2026", "06/02/2026", "07/02/2026"];
    var capasInfo = fechas.map(f => ({
        fecha: f,
        layer: L.tileLayer(f.replace(/\//g, '') + '/Z{z}/{y}/{x}.png', { maxZoom: 23 })
    }));

    const selLeft = document.getElementById('select-left');
    const selRight = document.getElementById('select-right');
    fechas.forEach((f, i) => {
        selLeft.add(new Option(f, i));
        selRight.add(new Option(f, i));
    });

    selLeft.value = 0; 
    selRight.value = fechas.length - 1; // Última fecha por defecto

    let leftLayer = capasInfo[selLeft.value].layer.addTo(map);
    let rightLayer = capasInfo[selRight.value].layer.addTo(map);
    let sbsControl = L.control.sideBySide(leftLayer, rightLayer).addTo(map);

    function updateComparison() {
        map.removeLayer(leftLayer);
        map.removeLayer(rightLayer);
        leftLayer = capasInfo[selLeft.value].layer.addTo(map);
        rightLayer = capasInfo[selRight.value].layer.addTo(map);
        sbsControl.setLeftLayers(leftLayer);
        sbsControl.setRightLayers(rightLayer);
    }
    selLeft.onchange = updateComparison;
    selRight.onchange = updateComparison;

    // 4. LÓGICA DE MEDICIÓN (PERSISTENTE)
    let currentMode = null, drawingPoints = [], tempLayer = null, guideLine = null;
    let features = {}, counters = { line: 0, area: 0, point: 0 };
    let pointLabels = {};

    function setMode(mode) {
        currentMode = mode;
        drawingPoints = [];
        if(tempLayer) map.removeLayer(tempLayer);
        if(guideLine) map.removeLayer(guideLine);
        document.querySelectorAll('.tool-btn').forEach(b => { if(b.id !== 'btn-project') b.classList.remove('active'); });
        if(mode) document.getElementById(`btn-${mode}`).classList.add('active');
    }

    document.getElementById('btn-line').onclick = () => setMode('line');
    document.getElementById('btn-area').onclick = () => setMode('area');
    document.getElementById('btn-point').onclick = () => setMode('point');

    map.on('mousemove', (e) => {
        const utm = toUTM(e.latlng);
        document.getElementById('utm-coord').innerText = `E: ${utm.x.toFixed(2)} | N: ${utm.y.toFixed(2)}`;
        if (currentMode && drawingPoints.length > 0) {
            if (guideLine) map.removeLayer(guideLine);
            guideLine = L.polyline([drawingPoints[drawingPoints.length-1], e.latlng], { color: 'white', weight: 1, dashArray: '5,10' }).addTo(map);
        }
    });

    map.on('click', (e) => {
        if (!currentMode) return;
        if (currentMode === 'point') { 
            createFeature('point', [e.latlng]); 
            setMode(null); 
        } else if (currentMode === 'line') {
            drawingPoints.push(e.latlng);
            if (drawingPoints.length === 2) { createFeature('line', [...drawingPoints]); setMode(null); }
        } else if (currentMode === 'area') {
            if (drawingPoints.length >= 3 && map.distance(e.latlng, drawingPoints[0]) < 15) {
                createFeature('area', [...drawingPoints]); setMode(null);
            } else {
                drawingPoints.push(e.latlng);
                if (tempLayer) map.removeLayer(tempLayer);
                tempLayer = L.polyline(drawingPoints, {color:'red'}).addTo(map);
            }
        }
    });

    function createFeature(type, coords) {
        const id = Date.now(); counters[type]++;
        let layer, name = `${type==='line'?'LÍNEA':type==='area'?'ÁREA':'PUNTO'} ${counters[type]}`;
        
        if(type === 'line') layer = L.polyline(coords, {color:'red', weight:3}).addTo(map);
        else if(type === 'area') layer = L.polygon(coords, {color:'red', weight:2, fillOpacity:0.3}).addTo(map);
        else {
            layer = L.circleMarker(coords[0], { radius: 6, color: 'red', fillColor: 'white', fillOpacity: 1 }).addTo(map);
            pointLabels[id] = L.marker(coords[0], { icon: L.divIcon({ className:'point-name-label', html: name, iconAnchor:[40,25] }), interactive:false }).addTo(map);
        }

        features[id] = { id, type, name, layer };
        addSidebarCard(id);
        layer.on('click', (ev) => { L.DomEvent.stopPropagation(ev); selectFeature(id); });
        selectFeature(id);
    }

    function addSidebarCard(id) {
        const f = features[id];
        const card = document.createElement('div');
        card.className = 'feature-card'; card.id = `card-${id}`;
        card.onclick = () => selectFeature(id);
        card.innerHTML = `
            <div class="card-header">
                <span class="card-title" id="title-${id}">${f.name}</span>
                <button class="btn-del-main" onclick="deleteFeat(${id}, event)">ELIMINAR</button>
            </div>
            <div class="card-content" id="coords-${id}"></div>`;
        document.getElementById(`list-${f.type}`).appendChild(card);
        updateCardData(id);
    }

    function updateCardData(id) {
        const f = features[id];
        let latlngs = f.type === 'point' ? [f.layer.getLatLng()] : (f.type === 'area' ? f.layer.getLatLngs()[0] : f.layer.getLatLngs());
        
        if(f.type === 'line') {
            let d = 0; for(let i=0; i<latlngs.length-1; i++) d += map.distance(latlngs[i], latlngs[i+1]);
            document.getElementById(`title-${id}`).innerText = `${f.name}: ${d.toFixed(2)} m`;
        } else if(f.type === 'area') {
            let area = 0; const utms = latlngs.map(ll => toUTM(ll));
            for (let i = 0; i < utms.length; i++) {
                let j = (i + 1) % utms.length;
                area += utms[i].x * utms[j].y; area -= utms[j].x * utms[i].y;
            }
            document.getElementById(`title-${id}`).innerText = `${f.name}: ${(Math.abs(area)/2).toFixed(2)} m²`;
        }
        document.getElementById(`coords-${id}`).innerHTML = latlngs.map((ll, i) => {
            const u = toUTM(ll);
            return `<div class="utm-row"><span>V${i+1}: E ${u.x.toFixed(2)} | N ${u.y.toFixed(2)}</span></div>`;
        }).join('');
    }

    function selectFeature(id) {
        deselectAll();
        document.getElementById(`card-${id}`).classList.add('selected');
        if(features[id].type !== 'point') features[id].layer.setStyle({color:'cyan', weight:4});
    }

    function deselectAll() {
        Object.values(features).forEach(f => {
            if(f.type !== 'point') f.layer.setStyle({color:'red', weight:2});
            document.getElementById(`card-${f.id}`).classList.remove('selected');
        });
    }

    function deleteFeat(id, ev) {
        ev.stopPropagation();
        map.removeLayer(features[id].layer);
        if(pointLabels[id]) map.removeLayer(pointLabels[id]);
        document.getElementById(`card-${id}`).remove();
        delete features[id];
    }
</script>
</body>
</html>
