<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <title>Subestación Fotovoltaica - Medición y Progreso</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <style>
    :root {
      --primary-color: #00ff00;
      --bg-dark: rgba(0, 0, 0, 0.9);
    }
    body { margin:0; padding:0; font-family: 'Segoe UI', Arial, sans-serif; background: #1a1a1a; }

    /* SIDEBAR IZQUIERDO */
    #sidebar {
      position: fixed; left: 0; top: 0; bottom: 0;
      width: 300px; background: #f8f9fa;
      border-right: 1px solid #ccc; padding: 15px;
      overflow-y: auto; z-index: 2000;
    }

    #map-container {
      position: absolute; left: 300px; top: 0; right: 0; bottom: 0;
    }
    #map { width: 100%; height: 100%; cursor: crosshair; }

    /* TOOLBAR DERECHO (Botones de texto) */
    #toolbar {
      position: fixed; right: 20px; top: 20%;
      display: flex; flex-direction: column; gap: 10px;
      z-index: 2500;
    }

    .btn-tool {
      background: var(--bg-dark); color: white;
      border: 1px solid #444; padding: 10px 15px;
      border-radius: 8px; cursor: pointer;
      font-weight: bold; text-align: center;
      transition: all 0.2s; min-width: 100px;
    }
    .btn-tool:hover { background: #333; border-color: var(--primary-color); }
    .btn-tool.active { background: #1976d2; border-color: #fff; }

    /* PANEL DE ACCIÓN (Aceptar/Cancelar) */
    #action-panel {
      display: none; flex-direction: row; gap: 10px;
      margin-top: 20px; border-top: 2px solid #444; pt: 10px;
    }
    .btn-confirm { background: #2e7d32; }
    .btn-cancel { background: #c62828; }

    /* SLIDER INFERIOR (Progreso Ortofotos) */
    .ui-container {
      position: absolute; bottom: 30px; left: 50%;
      transform: translateX(-50%); width: 400px;
      z-index: 2500; display: flex; flex-direction: column; gap: 8px;
    }
    .utm-box {
      background: var(--bg-dark); color: var(--primary-color);
      padding: 5px 12px; border-radius: 4px; text-align: center;
      font-family: monospace; font-size: 12px;
    }
    .slider-wrapper {
      background: var(--bg-dark); padding: 12px;
      border-radius: 8px; border: 1px solid #333; text-align: center;
    }
    .current-date-label {
      color: var(--primary-color); font-size: 12px; font-weight: bold;
      border: 1px solid var(--primary-color); padding: 2px 8px;
      border-radius: 4px; margin-bottom: 8px; display: inline-block;
    }
    input[type=range] { width: 100%; accent-color: var(--primary-color); cursor: pointer; }

    /* Estilos de lista en sidebar */
    .section-title { font-weight: bold; margin: 15px 0 5px; border-bottom: 1px solid #ccc; font-size: 14px; }
    .item-text { font-size: 11px; padding: 5px; border-bottom: 1px solid #eee; cursor: pointer; white-space: pre-line; }
    .active-item { background: #e3f2fd; border-left: 4px solid #1976d2; }
    .delete-btn { font-size: 10px; color: red; cursor: pointer; border: none; background: none; }
  </style>
</head>
<body>

<div id="sidebar">
  <h3>Panel de Control</h3>
  <div class="section-title">Líneas (Medir)</div>
  <div id="line-list"></div>
  <div class="section-title">Áreas</div>
  <div id="area-list"></div>
  <div class="section-title">Ubicaciones</div>
  <div id="point-list"></div>
</div>

<div id="map-container">
  <div id="map"></div>
</div>

<div id="toolbar">
  <button class="btn-tool" id="tool-line">MEDIR</button>
  <button class="btn-tool" id="tool-area">ÁREA</button>
  <button class="btn-tool" id="tool-point">PUNTO</button>
  <button class="btn-tool" id="tool-edit">EDICIÓN</button>

  <div id="action-panel">
    <button class="btn-tool btn-confirm" id="btn-accept">ACEPTAR</button>
    <button class="btn-tool btn-cancel" id="btn-cancel">CANCELAR</button>
  </div>
</div>

<div class="ui-container">
  <div class="utm-box" id="utm-coord">E: --- | N: ---</div>
  <div class="slider-wrapper">
    <div id="fecha-label" class="current-date-label">CARGANDO...</div>
    <input type="range" id="smooth-slider" min="0" value="0" step="1">
  </div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/proj4js/2.9.0/proj4.js"></script>

<script>
  // 1. CONFIGURACIÓN INICIAL Y MAPA
  var utm19S = "+proj=utm +zone=19 +south +datum=WGS84 +units=m +no_defs";
  var wgs84 = "+proj=longlat +datum=WGS84 +no_defs";

  var map = L.map('map', { zoomControl: false }).setView([-20.351387, -69.721985], 19);

  L.tileLayer('https://mt1.google.com/vt/lyrs=s&x={x}&y={y}&z={z}', { maxZoom: 23 }).addTo(map);

  // 2. CAPAS DE PROGRESO (ORTOFOTOS)
  var fechas = ["03/12/2025", "09/01/2026", "21/01/2026", "23/01/2026", "28/01/2026"];
  var capas = [
    L.tileLayer('03122025/Z{z}/{y}/{x}.png', { maxZoom: 23, opacity: 1 }).addTo(map),
    L.tileLayer('09012026/Z{z}/{y}/{x}.png', { maxZoom: 23, opacity: 0 }).addTo(map),
    L.tileLayer('21012026/Z{z}/{y}/{x}.png', { maxZoom: 23, opacity: 0 }).addTo(map),
    L.tileLayer('23012026/Z{z}/{y}/{x}.png', { maxZoom: 23, opacity: 0 }).addTo(map),
    L.tileLayer('28012026/Z{z}/{y}/{x}.png', { maxZoom: 23, opacity: 0 }).addTo(map)
  ];

  // Lógica del Slider
  var slider = document.getElementById('smooth-slider');
  var label = document.getElementById('fecha-label');
  slider.max = (capas.length - 1) * 100;

  function updateSlider() {
    var val = parseFloat(slider.value);
    var index = Math.floor(val / 100);
    var subVal = (val % 100) / 100;
    if (index >= capas.length - 1) { index = capas.length - 2; subVal = 1; }

    capas.forEach((c, i) => {
      if (i === index) c.setOpacity(1 - subVal);
      else if (i === index + 1) c.setOpacity(subVal);
      else c.setOpacity(0);
    });
    label.innerText = (subVal > 0.5) ? fechas[index + 1] : fechas[index];
  }
  slider.addEventListener('input', updateSlider);

  // 3. HERRAMIENTAS DE MEDICIÓN
  var currentMode = null;
  var lines = [], areas = [], points = [];
  var tempShape = null, pointsArray = [];
  var highlightedFeature = null;

  function setMode(mode) {
    currentMode = mode;
    // Reset de botones UI
    document.querySelectorAll('.btn-tool').forEach(b => b.classList.remove('active'));
    document.getElementById('action-panel').style.display = mode ? 'flex' : 'none';
    
    if(mode) document.getElementById('tool-' + mode).classList.add('active');
    
    // Reset de estados de dibujo
    pointsArray = [];
    if(tempShape) { map.removeLayer(tempShape); tempShape = null; }
    if(mode !== 'edit') removeEditMarkers();
  }

  // Eventos de botones
  document.getElementById('tool-line').onclick = () => setMode('line');
  document.getElementById('tool-area').onclick = () => setMode('area');
  document.getElementById('tool-point').onclick = () => setMode('point');
  document.getElementById('tool-edit').onclick = () => {
    setMode('edit');
    buildEditMarkers();
  };

  document.getElementById('btn-cancel').onclick = () => {
    setMode(null);
  };

  document.getElementById('btn-accept').onclick = () => {
    if (currentMode === 'area' && pointsArray.length >= 3) {
      finalizeArea();
    }
    setMode(null);
  };

  // Clic en el Mapa
  map.on('click', function(e) {
    if (!currentMode) return;

    if (currentMode === 'line') {
      pointsArray.push(e.latlng);
      if (pointsArray.length === 2) {
        finalizeLine(pointsArray);
        setMode(null); // Auto-deseleccionar
      }
    } 
    else if (currentMode === 'area') {
      pointsArray.push(e.latlng);
      if (tempShape) map.removeLayer(tempShape);
      tempShape = L.polyline(pointsArray, {color: 'red'}).addTo(map);
    }
    else if (currentMode === 'point') {
      finalizePoint(e.latlng);
      setMode(null); // Auto-deseleccionar
    }
  });

  // Funciones de finalización
  function finalizeLine(pts) {
    var line = L.polyline(pts, {color: '#1976d2', weight: 4}).addTo(map);
    var dist = map.distance(pts[0], pts[1]);
    var utm1 = latLngToUTM(pts[0]);
    var utm2 = latLngToUTM(pts[1]);
    
    var div = document.createElement('div');
    div.className = 'item-text';
    div.innerHTML = `<b>Línea: ${dist.toFixed(2)}m</b>\nE1:${utm1.e.toFixed(2)} N1:${utm1.n.toFixed(2)}\nE2:${utm2.e.toFixed(2)} N2:${utm2.n.toFixed(2)}`;
    document.getElementById('line-list').appendChild(div);
    lines.push({layer: line, data: div});
  }

  function finalizeArea() {
    var poly = L.polygon(pointsArray, {color: '#2e7d32', fillOpacity: 0.3}).addTo(map);
    var div = document.createElement('div');
    div.className = 'item-text';
    div.innerHTML = `<b>Área creada</b>\n(Ver coordenadas en edición)`;
    document.getElementById('area-list').appendChild(div);
    areas.push({layer: poly, data: div});
  }

  function finalizePoint(latlng) {
    var utm = latLngToUTM(latlng);
    L.marker(latlng).addTo(map);
    var div = document.createElement('div');
    div.className = 'item-text';
    div.innerHTML = `<b>Punto UTM:</b>\nE: ${utm.e.toFixed(2)} N: ${utm.n.toFixed(2)}`;
    document.getElementById('point-list').appendChild(div);
  }

  // Utilidades UTM
  function latLngToUTM(ll) {
    var p = proj4(wgs84, utm19S, [ll.lng, ll.lat]);
    return { e: p[0], n: p[1] };
  }

  map.on('mousemove', function(e) {
    var p = latLngToUTM(e.latlng);
    document.getElementById('utm-coord').innerHTML = `E: ${p.e.toFixed(2)} | N: ${p.n.toFixed(2)}`;
  });

  // Gestión de edición (Simplificada)
  var editMarkers = [];
  function buildEditMarkers() {
    removeEditMarkers();
    // Aquí se añadiría la lógica de puntos de arrastre para la última figura seleccionada
  }
  function removeEditMarkers() {
    editMarkers.forEach(m => map.removeLayer(m));
    editMarkers = [];
  }

  updateSlider();
</script>
</body>
</html>
