<!DOCTYPE html>
<html>
<head>
    <title>Visor Ingeniería - Jeraldo & Rodriguez</title>
    <meta charset="utf-8" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://unpkg.com/@geoman-io/leaflet-geoman-free@latest/dist/leaflet-geoman.css" />
    <style>
        body { margin: 0; padding: 0; background: #1a1a1a; font-family: 'Segoe UI', sans-serif; overflow: hidden; }
        #map { height: 100vh; width: 100%; cursor: crosshair; }
        
        .brand-logo {
            position: absolute; bottom: 20px; left: 20px; z-index: 2500;
            width: 150px; filter: drop-shadow(0 2px 5px rgba(0,0,0,0.7));
            pointer-events: none;
        }

        .ui-container {
            position: absolute; bottom: 25px; left: 50%; transform: translateX(-50%);
            width: 25%; min-width: 220px; z-index: 2000;
            display: flex; flex-direction: column; align-items: center; gap: 8px;
        }

        .utm-box {
            background: rgba(0,0,0,0.9); color: #00ff00; padding: 4px 10px;
            border-radius: 4px; border: 1px solid #444; font-family: monospace;
            font-size: 10px; font-weight: bold;
        }

        .slider-wrapper {
            background: rgba(0,0,0,0.9); padding: 12px 15px; border-radius: 8px;
            width: 100%; border: 1px solid #333; text-align: center;
        }

        .current-date-label { 
            display: inline-block; color: #00ff00; font-size: 12px; font-weight: bold;
            border: 1px solid #00ff00; padding: 2px 8px; border-radius: 4px;
            margin-bottom: 8px; background: rgba(0, 255, 0, 0.05);
        }

        .date-active { background: #00ff00 !important; color: #000 !important; }
        input[type=range] { width: 100%; cursor: pointer; accent-color: #00ff00; height: 3px; }
    </style>
</head>
<body>

<img src="logo.jpg" class="brand-logo" alt="Logo Jeraldo & Rodriguez">
<div id="map"></div>

<div class="ui-container">
    <div class="utm-box" id="utm-coord">E: --- | N: ---</div>
    <div class="slider-wrapper">
        <div id="fecha-label" class="current-date-label">CARGANDO...</div>
        <input type="range" id="smooth-slider" min="0" value="0" step="1">
    </div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/proj4js/2.9.0/proj4.js"></script>
<script src="https://unpkg.com/@geoman-io/leaflet-geoman-free@latest/dist/leaflet-geoman.min.js"></script>

<script>
    var utm19S = "+proj=utm +zone=19 +south +datum=WGS84 +units=m +no_defs";
    var wgs84 = "+proj=longlat +datum=WGS84 +no_defs";

    var map = L.map('map', { zoomControl: false, minZoom: 18, maxZoom: 23 })
              .setView([-20.351387, -69.721985], 19);

    L.tileLayer('https://mt1.google.com/vt/lyrs=s&x={x}&y={y}&z={z}', { maxZoom: 23 }).addTo(map);

    // PANEL PARA EL PLANO (Encima de todo)
    map.createPane('planoPane');
    map.getPane('planoPane').style.zIndex = 1000;
    map.getPane('planoPane').style.pointerEvents = 'none';

    // COORDENADAS SEGÚN TU IMAGEN (North, West, South, East)
    var imageBounds = [
        [-20.3519680745, -69.7226506296], // Esquina Sur-Oeste [South, West]
        [-20.3506811321, -69.7212255524]  // Esquina Norte-Este [North, East]
    ];

    // CARGA DE FUNDACIONES.PNG
    L.imageOverlay('fundaciones.png', imageBounds, {
        pane: 'planoPane',
        opacity: 0.9,
        interactive: false
    }).addTo(map);

    // COORDENADAS UTM
    map.on('mousemove', function(e) {
        var p = proj4(wgs84, utm19S, [e.latlng.lng, e.latlng.lat]);
        document.getElementById('utm-coord').innerHTML = `E: ${p[0].toFixed(2)} | N: ${p[1].toFixed(2)}`;
    });

    // FOTOS Y SLIDER
    var fechas = ["03/12/2025", "09/01/2026", "21/01/2026", "23/01/2026", "28/01/2026"];
    var capas = [
        L.tileLayer('03122025/Z{z}/{y}/{x}.png', { maxZoom: 23, opacity: 1 }).addTo(map),
        L.tileLayer('09012026/Z{z}/{y}/{x}.png', { maxZoom: 23, opacity: 0 }).addTo(map),
        L.tileLayer('21012026/Z{z}/{y}/{x}.png', { maxZoom: 23, opacity: 0 }).addTo(map),
        L.tileLayer('23012026/Z{z}/{y}/{x}.png', { maxZoom: 23, opacity: 0 }).addTo(map),
        L.tileLayer('28012026/Z{z}/{y}/{x}.png', { maxZoom: 23, opacity: 0 }).addTo(map)
    ];

    var slider = document.getElementById('smooth-slider');
    var label = document.getElementById('fecha-label');
    slider.max = (capas.length - 1) * 100;

    function updateView() {
        var val = parseFloat(slider.value);
        var snappingPoint = Math.round(val / 100) * 100;
        if (Math.abs(val - snappingPoint) < 12) { val = snappingPoint; }

        var index = Math.floor(val / 100);
        var subVal = (val % 100) / 100;
        if (index >= capas.length - 1) { index = capas.length - 2; subVal = 1; }
        
        capas.forEach((c, i) => {
            if (i === index) c.setOpacity(1 - subVal);
            else if (i === index + 1) c.setOpacity(subVal);
            else c.setOpacity(0);
        });
        
        var fechaActual = (subVal > 0.5) ? fechas[index + 1] : fechas[index];
        label.innerText = fechaActual;

        if (subVal === 0 || subVal === 1) label.classList.add('date-active');
        else label.classList.remove('date-active');
    }

    slider.addEventListener('input', updateView);
    slider.addEventListener('change', function() {
        this.value = Math.round(this.value / 100) * 100;
        updateView();
    });

    updateView();
    map.pm.addControls({ position: 'topleft', drawPolyline: true, drawPolygon: true });
</script>
</body>
</html>